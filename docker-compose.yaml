services:
  app:
    image: golang
    container_name: bookmarks-app
    working_dir: /app
    volumes:
      - .:/app
    command: go run server.go
    ports:
      - "3002:3002"
    environment:
      STORE: couchdb
      COUCH_URL: http://couchdb:5984
      COUCH_USER: admin
      COUCH_PASS: admin
      COUCH_DB: fribrowsedb
    depends_on:
      couchdb:
        condition: service_healthy

  couchdb:
    image: couchdb:latest
    container_name: bookmarks-couchdb
    restart: unless-stopped
    ports:
      - "5984:5984"
    environment:
      COUCHDB_USER: admin
      COUCHDB_PASSWORD: admin
    volumes:
      - couchdb-data:/opt/couchdb/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/_up"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Optional: Initialize CouchDB system databases
  couchdb-init:
    image: curlimages/curl:latest
    container_name: bookmarks-couchdb-init
    depends_on:
      couchdb:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Creating CouchDB system databases..."
        curl -X PUT http://admin:admin@couchdb:5984/_users
        curl -X PUT http://admin:admin@couchdb:5984/_replicator
        curl -X PUT http://admin:admin@couchdb:5984/_global_changes
        echo "System databases created!"
    restart: "no"

volumes:
  couchdb-data:
